package org.opentestsystem.rdw.admin.repository.impl;

import org.opentestsystem.rdw.admin.model.ImportStatus;
import org.opentestsystem.rdw.admin.model.StudentGroupUpload;
import org.opentestsystem.rdw.admin.repository.StudentGroupUploadRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.sql.ResultSet;
import java.sql.SQLException;

/**
 * JDBC implementation of a StudentGroupUploadRepository.
 */
@Repository
public class JdbcStudentGroupUploadRepository implements StudentGroupUploadRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.student_group_upload.create}")
    private String sqlCreate;

    @Value("${sql.student_group_upload.findOne}")
    private String sqlFindOne;

    @Value("${sql.student_group_upload.findOneByDigest}")
    private String sqlFindOneByDigest;

    @Value("${sql.student_group_upload.sqlFindByCreator}")
    private String sqlFindByCreator;

    @Autowired
    public JdbcStudentGroupUploadRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    @Transactional
    public StudentGroupUpload create(final StudentGroupUpload studentGroupUpload) {
        final KeyHolder keyHolder = new GeneratedKeyHolder();
        final SqlParameterSource parameterSource = new MapSqlParameterSource()
                .addValue("status", studentGroupUpload.getStatus().getValue())
                .addValue("digest", studentGroupUpload.getDigest())
                .addValue("creator", studentGroupUpload.getCreator())
                .addValue("message", studentGroupUpload.getMessage());

        jdbcTemplate.update(sqlCreate, parameterSource, keyHolder);

        return findOne(keyHolder.getKey().longValue());
    }

    @Override
    public StudentGroupUpload findOne(final long id) {
        try {
            return jdbcTemplate.queryForObject(sqlFindOne, new MapSqlParameterSource().addValue("id", id), new StudentGroupUploadRowMapper());
        } catch (final EmptyResultDataAccessException ignored) {
            return null;
        }
    }

    @Override
    public StudentGroupUpload findOneByDigest(final String digest) {
        try {
            return jdbcTemplate.queryForObject(sqlFindOneByDigest, new MapSqlParameterSource().addValue("digest", digest), new StudentGroupUploadRowMapper());
        } catch (final EmptyResultDataAccessException ignored) {
            return null;
        }
    }

    @Override
    public Iterable<StudentGroupUpload> findByCreator(final String creator) {
        return jdbcTemplate.query(sqlFindByCreator, new MapSqlParameterSource().addValue("creator", creator), new StudentGroupUploadRowMapper());
    }

    private static class StudentGroupUploadRowMapper implements RowMapper<StudentGroupUpload> {
        @Override
        public StudentGroupUpload mapRow(final ResultSet rs, final int rowNum) throws SQLException {
            return StudentGroupUpload.builder()
                    .id(rs.getLong("id"))
                    .digest(rs.getString("digest"))
                    .status(ImportStatus.fromValue(rs.getInt("status")))
                    .creator(rs.getString("creator"))
                    .created(rs.getTimestamp("created").toInstant())
                    .updated(rs.getTimestamp("updated").toInstant())
                    .message(rs.getString("message"))
                    .build();
        }
    }
}
