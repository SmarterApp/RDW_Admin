package org.opentestsystem.rdw.admin.service;

import com.google.common.collect.ImmutableSet;
import org.apache.commons.csv.CSVRecord;
import org.opentestsystem.rdw.admin.model.CsvValidationFailure;
import org.opentestsystem.rdw.admin.security.User;

import java.util.Iterator;
import java.util.List;
import java.util.Set;

/**
 * Implementations of this interface are responsible for validating
 * a CSV representation of a Student Group submission.
 */
public interface CsvValidationService {

    final static String HeaderSchool = "school_natural_id";
    final static String HeaderSubject = "subject_code";
    final static String HeaderGroup = "group_name";
    final static String HeaderUser = "group_user_login";
    final static String HeaderYear = "school_year";
    final static String HeaderSSID = "student_ssid";

    final static Set<String> RequiredHeaders = ImmutableSet.of(
            HeaderSchool,
            HeaderSubject,
            HeaderGroup,
            HeaderUser,
            HeaderYear,
            HeaderSSID
    );

    /**
     * Validate the given CSV's headers and return the collection
     * of validation failures.
     *
     * @param csvHeaders CSV headers
     * @return The list of validation failures, empty if valid
     */
    List<CsvValidationFailure> validateHeaders(Set<String> csvHeaders);

    /**
     * Validate the given CSV records and return the collection
     * of validation failures.
     *
     * @param recordIterator    CSV records
     * @param user              The authenticated user
     * @return The list of validation failures, empty if valid
     */
    List<CsvValidationFailure> validateRecords(Iterator<CSVRecord> recordIterator, User user);

    /**
     * Convert a collection of CSV validation failures into a single
     * truncated message string.
     *
     * @param failures A collection of CSV validation failures
     * @return A string representation of the failure messages
     */
    String toMessage(List<CsvValidationFailure> failures);
}
